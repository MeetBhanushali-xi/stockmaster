<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Deliveries - StockMaster</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { overflow-x: hidden; }

  /* Sidebar */
  .sidebar {
    width: 250px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    background: #1e1e2f;
    padding-top: 20px;
    color: white;
  }
  .sidebar a {
    color: #d2d2d2;
    padding: 12px 20px;
    display: block;
    text-decoration: none;
    border-radius: 5px;
    margin: 4px 8px;
  }
  .sidebar a.active,
  .sidebar a:hover {
    background: #34344a;
    color: white;
  }
  .brand {
    font-size: 20px;
    font-weight: bold;
    padding-left: 20px;
    margin-bottom: 20px;
  }

  /* Content area */
  .content {
    margin-left: 260px;
    padding: 20px;
  }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="brand">StockMaster</div>

  <a href="dashboard.html" id="menu-dashboard">Dashboard</a>
  <a href="products.html" id="menu-products">Products</a>
  <a href="receipts.html" id="menu-receipts">Receipts</a>
  <a href="deliveries.html" id="menu-deliveries">Deliveries</a>
  <a href="transfers.html" id="menu-transfers">Transfers</a>


  <hr style="border-color:#555;">
  <a href="forgot_password.html">Forgot Password</a>
  <a href="login.html">Logout</a>
</div>

<!-- MAIN CONTENT -->
<div class="content">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Deliveries</h4>
    <div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeliveryModal">+ New Delivery</button>
      <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Status</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="deliveriesBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ADD DELIVERY MODAL -->
<div class="modal fade" id="addDeliveryModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Create Delivery</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input id="d_customer" class="form-control mb-2" placeholder="Customer name">

        <div class="mb-2">
          <h6>Items</h6>
          <div id="dItemsList"></div>
          <button class="btn btn-sm btn-outline-primary mt-2" id="dAddItemBtn">+ Add Item</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveDeliveryBtn">Save Delivery</button>
      </div>

    </div>
  </div>
</div>

<script>
// Highlight active menu
function activateMenu(id){
  const el = document.getElementById(id);
  if (el) el.classList.add("active");
}
activateMenu("menu-deliveries");


// === API ENDPOINTS ===
const apiDeliveries = "/api/deliveries";
const apiProducts = "/api/products";

let productsCache = [];

// Load products + deliveries
async function loadAll() {
  document.getElementById("refreshBtn").disabled = true;
  await Promise.all([loadProducts(), loadDeliveries()]);
  document.getElementById("refreshBtn").disabled = false;
}

async function loadProducts() {
  const res = await fetch(apiProducts);
  productsCache = await res.json();
}

async function loadDeliveries() {
  const res = await fetch(apiDeliveries);
  const deliveries = await res.json();

  const tbody = document.getElementById("deliveriesBody");
  tbody.innerHTML = "";

  deliveries.forEach(d => {
    const itemsHtml = (d.items || []).map(it => {
      const prod = productsCache.find(p => Number(p.id) === Number(it.productId));
      const name = prod ? prod.name : `#${it.productId}`;
      return `${name} (x${it.qty})`;
    }).join("<br>");

    tbody.innerHTML += `
      <tr>
        <td>${d.id}</td>
        <td>${d.customer}</td>
        <td>${itemsHtml}</td>
        <td>${d.status}</td>
        <td>${new Date(d.createdAt).toLocaleString()}</td>
        <td>
          ${
            d.status !== "Done"
              ? `<button class="btn btn-sm btn-success" onclick="validateDelivery(${d.id})">Validate</button>`
              : `<span class="badge bg-success">Validated</span>`
          }
        </td>
      </tr>
    `;
  });
}

// Add item row
function addDeliveryItemRow(productId = "", qty = 1) {
  const id = Date.now() + Math.random().toString(36).slice(2,7);
  const div = document.createElement("div");
  div.className = "d-flex gap-2 mb-2 align-items-center";
  div.id = "dItemRow_" + id;

  const sel = document.createElement("select");
  sel.className = "form-select";
  sel.style.minWidth = "300px";

  const empty = document.createElement("option");
  empty.value = "";
  empty.text = "-- Select product --";
  sel.appendChild(empty);

  productsCache.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id;
    o.text = `${p.name} (stock: ${p.total_stock || 0})`;
    if (String(p.id) === String(productId)) o.selected = true;
    sel.appendChild(o);
  });

  const q = document.createElement("input");
  q.type = "number";
  q.className = "form-control";
  q.style.width = "100px";
  q.value = qty;

  const rem = document.createElement("button");
  rem.className = "btn btn-outline-danger btn-sm";
  rem.innerText = "Remove";
  rem.onclick = () => div.remove();

  div.appendChild(sel);
  div.appendChild(q);
  div.appendChild(rem);

  document.getElementById("dItemsList").appendChild(div);
}

// Save delivery
document.getElementById("saveDeliveryBtn").addEventListener("click", async () => {
  const customer = document.getElementById("d_customer").value.trim();
  if (!customer) return alert("Enter customer name");

  const itemsDivs = Array.from(document.getElementById("dItemsList").children);
  const items = itemsDivs.map(d => {
    const sel = d.querySelector("select");
    const q = d.querySelector("input[type='number']");
    return { productId: sel.value, qty: Number(q.value) };
  }).filter(it => it.productId && it.qty > 0);

  if (items.length === 0) return alert("Add at least one item");

  const res = await fetch(apiDeliveries, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ customer, items })
  });

  const data = await res.json();
  if (data.success) {
    new bootstrap.Modal(document.getElementById("addDeliveryModal")).hide();
    document.getElementById("d_customer").value = "";
    document.getElementById("dItemsList").innerHTML = "";
    loadAll();
  } else {
    alert("Failed to save: " + (data.message || "unknown"));
  }
});

// Validate delivery
async function validateDelivery(id) {
  if (!confirm("Validate this delivery? This will reduce product quantities.")) return;

  const res = await fetch(`${apiDeliveries}/${id}/validate`, { method: "PUT" });

  if (res.status === 400) {
    const err = await res.json();
    alert("Cannot validate: " + (err.message || "insufficient stock"));
    return;
  }

  const data = await res.json();
  if (data.success) {
    alert("Delivery validated and stock updated.");
    loadAll();
  } else {
    alert("Failed: " + (data.message || "unknown"));
  }
}

// Event listeners
document.getElementById("dAddItemBtn").addEventListener("click", () => addDeliveryItemRow());
document.getElementById("refreshBtn").addEventListener("click", loadAll);

// Init page
(async () => {
  await loadProducts();
  addDeliveryItemRow();
  await loadDeliveries();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
