<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Internal Transfers - StockMaster</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { overflow-x: hidden; }
  .sidebar { width:250px;height:100vh;position:fixed;left:0;top:0;background:#1e1e2f;padding-top:20px;color:white; }
  .sidebar a { color:#d2d2d2;padding:12px 20px;display:block;text-decoration:none;border-radius:5px;margin:4px 8px; }
  .sidebar a.active,.sidebar a:hover { background:#34344a;color:white; }
  .brand{font-size:20px;font-weight:bold;padding-left:20px;margin-bottom:20px;}
  .content { margin-left:260px;padding:20px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="brand">StockMaster</div>

  <a href="dashboard.html" id="menu-dashboard">Dashboard</a>
  <a href="products.html" id="menu-products">Products</a>
  <a href="receipts.html" id="menu-receipts">Receipts</a>
  <a href="deliveries.html" id="menu-deliveries">Deliveries</a>
  <a href="transfers.html" id="menu-transfers">Transfers</a>

  <hr style="border-color:#555;">
  <a href="forgot_password.html">Forgot Password</a>
  <a href="login.html">Logout</a>
</div>

<div class="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Internal Transfers</h4>
    <div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransferModal">+ New Transfer</button>
      <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>From</th>
            <th>To</th>
            <th>Items</th>
            <th>Status</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="transfersBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h6>Location Stocks (Quick view)</h6>
      <div id="locationsView"></div>
    </div>
  </div>
</div>

<!-- Add Transfer Modal -->
<div class="modal fade" id="addTransferModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Create Internal Transfer</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-2 mb-2">
          <div class="col">
            <label class="form-label">From Location</label>
            <select id="fromLocation" class="form-select"></select>
          </div>
          <div class="col">
            <label class="form-label">To Location</label>
            <select id="toLocation" class="form-select"></select>
          </div>
        </div>

        <h6>Items</h6>
        <div id="transferItemsList"></div>
        <button id="addTransferItemBtn" class="btn btn-sm btn-outline-primary mt-2">+ Add Item</button>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveTransferBtn" class="btn btn-primary">Save Transfer</button>
      </div>

    </div>
  </div>
</div>

<script>
activateMenu("menu-transfers");

const apiTransfers = "/api/internal-transfers";
const apiProducts = "/api/products";
const apiLocations = "/api/locations";

let products = [];
let locations = [];

async function loadAll() {
  document.getElementById("refreshBtn").disabled = true;
  await Promise.all([loadProducts(), loadLocations(), loadTransfers()]);
  document.getElementById("refreshBtn").disabled = false;
}

async function loadProducts() {
  const res = await fetch(apiProducts);
  products = await res.json();
}

async function loadLocations() {
  const res = await fetch(apiLocations);
  locations = await res.json();

  // populate quick view
  const locView = document.getElementById("locationsView");
  locView.innerHTML = "";
  locations.forEach(l => {
    const container = document.createElement("div");
    container.className = "mb-2";
    container.innerHTML = `<strong>${l.name}</strong><br>` + (l.stock || []).map(s => {
      const p = products.find(pp => Number(pp.id) === Number(s.productId));
      const name = p ? p.name : `#${s.productId}`;
      return `${name}: ${s.qty}`;
    }).join(" â€¢ ");
    locView.appendChild(container);
  });
}

async function loadTransfers() {
  const res = await fetch(apiTransfers);
  const transfers = await res.json();
  const tbody = document.getElementById("transfersBody");
  tbody.innerHTML = "";
  transfers.forEach(t => {
    const from = locations.find(l => Number(l.id) === Number(t.fromLocationId))?.name || t.fromLocationId;
    const to = locations.find(l => Number(l.id) === Number(t.toLocationId))?.name || t.toLocationId;
    const itemsHtml = (t.items || []).map(it => {
      const p = products.find(pp => Number(pp.id) === Number(it.productId));
      const name = p ? p.name : `#${it.productId}`;
      return `${name} (x${it.qty})`;
    }).join("<br>");
    tbody.innerHTML += `
      <tr>
        <td>${t.id}</td>
        <td>${from}</td>
        <td>${to}</td>
        <td>${itemsHtml}</td>
        <td>${t.status}</td>
        <td>${new Date(t.createdAt).toLocaleString()}</td>
        <td>
          ${t.status !== "Done" ? `<button class="btn btn-sm btn-success" onclick="validateTransfer(${t.id})">Validate</button>` : `<span class="badge bg-success">Done</span>`}
        </td>
      </tr>
    `;
  });
}

// Add transfer item row
function addTransferItem(productId = "", qty = 1) {
  const id = Date.now() + Math.random().toString(36).slice(2,7);
  const div = document.createElement("div");
  div.className = "d-flex gap-2 mb-2 align-items-center";
  div.id = "tItem_" + id;

  const sel = document.createElement("select");
  sel.className = "form-select";
  sel.style.minWidth = "300px";
  const empty = document.createElement("option");
  empty.value = "";
  empty.text = "-- Select product --";
  sel.appendChild(empty);
  products.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id;
    o.text = `${p.name} (${p.sku || "no-sku"})`;
    if (String(p.id) === String(productId)) o.selected = true;
    sel.appendChild(o);
  });

  const qtyInp = document.createElement("input");
  qtyInp.type = "number";
  qtyInp.className = "form-control";
  qtyInp.style.width = "100px";
  qtyInp.value = qty;

  const rem = document.createElement("button");
  rem.className = "btn btn-outline-danger btn-sm";
  rem.innerText = "Remove";
  rem.onclick = () => div.remove();

  div.appendChild(sel);
  div.appendChild(qtyInp);
  div.appendChild(rem);

  document.getElementById("transferItemsList").appendChild(div);
}

// Save transfer
document.getElementById("saveTransferBtn").addEventListener("click", async () => {
  const fromId = document.getElementById("fromLocation").value;
  const toId = document.getElementById("toLocation").value;
  if (!fromId || !toId) return alert("Select both locations");
  if (fromId === toId) return alert("From and To locations must be different");

  const itemsDivs = Array.from(document.getElementById("transferItemsList").children);
  const items = itemsDivs.map(d => {
    const sel = d.querySelector("select");
    const q = d.querySelector("input[type='number']");
    return { productId: sel.value, qty: Number(q.value) };
  }).filter(it => it.productId && it.qty > 0);

  if (items.length === 0) return alert("Add at least one item");

  const res = await fetch(apiTransfers, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ fromLocationId: Number(fromId), toLocationId: Number(toId), items })
  });
  const data = await res.json();
  if (data.success) {
    new bootstrap.Modal(document.getElementById("addTransferModal")).hide();
    document.getElementById("transferItemsList").innerHTML = "";
    loadAll();
  } else {
    alert("Failed: " + (data.message || "unknown"));
  }
});

// Validate transfer
async function validateTransfer(id) {
  if (!confirm("Validate transfer? This will move stock between locations.")) return;
  const res = await fetch(`${apiTransfers}/${id}/validate`, { method: "PUT" });
  if (res.status === 400) {
    const err = await res.json();
    alert("Cannot validate: " + (err.message || "insufficient"));
    console.warn(err);
    return;
  }
  const data = await res.json();
  if (data.success) {
    alert("Transfer validated and stocks updated.");
    loadAll();
  } else {
    alert("Failed: " + (data.message || "unknown"));
  }
}

// open modal: populate locations selects
document.getElementById("addTransferItemBtn").addEventListener("click", () => addTransferItem());
document.getElementById("refreshBtn").addEventListener("click", loadAll);

// when add transfer modal opens populate location dropdowns
const addTransferModalEl = document.getElementById("addTransferModal");
addTransferModalEl && addTransferModalEl.addEventListener("show.bs.modal", () => {
  const fromSelect = document.getElementById("fromLocation");
  const toSelect = document.getElementById("toLocation");
  fromSelect.innerHTML = "<option value=''>-- Select --</option>";
  toSelect.innerHTML = "<option value=''>-- Select --</option>";
  locations.forEach(l => {
    const o1 = document.createElement("option"); o1.value = l.id; o1.text = l.name; fromSelect.appendChild(o1);
    const o2 = document.createElement("option"); o2.value = l.id; o2.text = l.name; toSelect.appendChild(o2);
  });
});

// initialize
(async () => {
  await loadProducts();
  await loadLocations();
  addTransferItem(); // seed one row
  await loadTransfers();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
